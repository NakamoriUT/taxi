# 配送ルート最適化アプリケーション 計算ロジック説明書

## 概要
本アプリケーションは、複数の配送先と複数の車両を考慮した配送ルート最適化問題（Vehicle Routing Problem: VRP）を解決するシステムです。Google OR-Toolsを使用して最適化計算を行い、実際の道路情報を考慮したルート表示を実現しています。

## 1. 最適化アルゴリズムの基本構造

### 1.1 使用技術
- **最適化エンジン**: Google OR-Tools (ortools==9.8.3296)
- **アルゴリズム**: 車両ルーティング問題（VRP）ソルバー
- **探索戦略**: PATH_CHEAPEST_ARC（最安経路優先）
- **メタヒューリスティック**: GUIDED_LOCAL_SEARCH（誘導付き局所探索）

### 1.2 最適化の目的
総走行時間（または距離）を最小化しながら、以下の制約を満たすルートを計算：
- すべての配送先を訪問
- 各配送先は1回のみ訪問
- 車両の積載量制限を超えない
- 時間枠制約を満たす
- 優先度の高い配送先を優先的に訪問

## 2. 距離・時間計算方式（ハイブリッド方式）

### 2.1 距離計算の3段階アプローチ

#### 第1段階：近距離（10km以下）
```
実効距離 = 直線距離 × 1.3 × 60
```
- 直線距離はHaversine公式で計算
- 係数1.3は道路の曲がりを考慮した経験値
- 60を掛けて分単位に変換

#### 第2段階：遠距離（10km超）
- OSRM (Open Source Routing Machine) APIを使用
- 実際の道路ネットワークに基づく走行時間を取得
- APIレスポンスから`duration`（秒）を取得し、分に変換

#### 第3段階：フォールバック
```
実効距離 = 直線距離 × 1.5 × 60
```
- API障害時の代替計算
- より大きな係数（1.5）で道路の迂回を考慮

### 2.2 Haversine公式による直線距離計算
```python
a = sin(Δlat/2)² + cos(lat1) × cos(lat2) × sin(Δlon/2)²
c = 2 × atan2(√a, √(1-a))
距離 = 地球半径(6371km) × c
```

## 3. 制約条件の処理

### 3.1 積載量制約
- 各車両には最大積載量が設定
- 各配送先には荷物量（demand）が設定
- 積載量を超える場合、自動的にデポ（出発地点）に戻って補充

#### 補充アルゴリズム（vrp_solver.py）
1. 現在の積載量 + 次の配送先の荷物量 ≤ 車両容量の場合
   - そのまま配送先へ移動
2. 積載量超過の場合
   - デポに戻る → 積載量リセット → 配送先へ移動
3. 単一配送が容量超過の場合
   - 警告を表示（物理的に配送不可能）

### 3.2 時間枠制約
- 各配送先に到着可能な時間帯を設定可能
- 10分単位で指定（例：9:00-17:00）
- OR-Toolsの時間次元（Time Dimension）で制約を実装

### 3.3 優先度
- 1-10の優先度を各配送先に設定
- 高優先度の配送先を優先的にルートに組み込む
- ペナルティ関数により低優先度配送の遅延を許容

## 4. 最適化プロセス

### 4.1 データ準備
1. **位置情報の収集**
   - デポ（出発地点）の緯度経度
   - 各配送先の緯度経度

2. **距離行列の構築**
   - n×nの距離行列（n = デポ + 配送先数）
   - 対称性を利用して計算量を削減（i→j = j→i）

3. **制約パラメータの設定**
   - 各車両の容量
   - 各配送先の荷物量、時間枠、優先度、作業時間

### 4.2 最適化実行
1. **初期解の生成**
   - PATH_CHEAPEST_ARC戦略で貪欲法による初期ルート作成

2. **解の改善**
   - GUIDED_LOCAL_SEARCHで局所最適解を探索
   - 最大10秒間の計算時間制限

3. **結果の検証**
   - 未訪問配送先のチェック
   - 容量制約違反の確認

### 4.3 フォールバック処理
OR-Toolsで解が見つからない場合：
1. 補充アルゴリズムで強制的にルート生成
2. 容量制約を優先し、他の制約を緩和
3. 未割当配送先を警告表示

## 5. ルート表示処理

### 5.1 最適化後の道路ルート取得
- 最適化で決定したルート順序に従い、各区間の道路ルートを取得
- OSRM、Valhalla等の複数のAPIを試行
- GeoJSON形式で道路に沿った座標列を取得

### 5.2 フォールバック表示
APIが利用できない場合：
- サイン曲線を使用した曲線ルートを生成
- 視覚的に自然な経路表示を実現

## 6. 性能最適化

### 6.1 計算時間の短縮
- ハイブリッド距離計算により、API呼び出しを最小限に
- 対称性を利用した距離行列計算
- 並列処理可能な部分の識別

### 6.2 スケーラビリティ
- 10配送先：数秒で計算完了
- 50配送先：30秒以内で計算完了（ハイブリッド方式）
- 100配送先以上：分割統治法の適用を推奨

## 7. アニメーション機能

### 7.1 車両移動の可視化
- 計算されたルートに沿って車両マーカーが移動
- 5段階の速度調整機能
- 特定車両への追従機能

### 7.2 進捗表示
- 各車両の配送進捗をリアルタイム表示
- デポでの補充タイミングの可視化
- 配送完了時の通知

## まとめ
本システムは、実用的な配送ルート最適化を実現するため、計算速度と精度のバランスを重視した設計となっています。ハイブリッド距離計算により、近距離配送では高速に、遠距離配送では正確な最適化を実現しています。また、様々な制約条件に対応し、実際の配送業務で発生する複雑な要件にも対応可能です。